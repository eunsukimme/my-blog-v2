---
title: Docker, AWS CodeBuild, CodeDeploy ê·¸ë¦¬ê³  CodePipeline ìœ¼ë¡œ Node.js í”„ë¡œì íŠ¸ CI/CD êµ¬ì¶•í•˜ê¸°
summary: Docker ì™€ AWS CodeBuild, CodeDeploy, CodePipeline ì„ í™œìš©í•´ Node.js í”„ë¡œì íŠ¸ì˜ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë´…ì‹œë‹¤.
date: '2020-08-25T02:30:00.000Z'
draft: false
slug: 'nodejs-cicd-pipeline-with-aws-codebuild-codedeploy-codepipeline'
category: DevOps
tags:
  - DevOps
  - Nodejs
  - AWS
  - Cloud
  - IAM
  - Docker
  - CodeBuild
  - CodeDeploy
  - CodePipeline
socialImage: '/media/node_codebuild_codedeploy_codepipeline/AWS_CICD.png'
---

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” Docker ì™€ AWS ì„œë¹„ìŠ¤ë¥¼ í™œìš©í•˜ì—¬ EC2 ì— Node.js ì•±ì„ ë°°í¬í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ì „ì²´ì ì¸ CI/CD ì•„í‚¤í…ì²˜ë¥¼ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/AWS_CICD.png](/media/node_codebuild_codedeploy_codepipeline/AWS_CICD.png)

ì „ì²´ì ì¸ íë¦„ì„ ì„¤ëª…í•˜ë©´, ê°œë°œìê°€ Github ì— ì½”ë“œë¥¼ í‘¸ì‰¬í•˜ë©´ CodePipeline ì´ ì´ë¥¼ ê°ì§€í•˜ê³ , CodeBuild ë¥¼ ì‹¤í–‰ì‹œì¼œ ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ìƒì„±ëœ ë„ì»¤ ì´ë¯¸ì§€ëŠ” Docker hub ì— ì˜¬ë¼ê°€ê³ , ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë“¤ì„ S3 ì— ì €ì¥ë©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ CodeDeploy ê°€ EC2 ìƒì˜ Agent ë¥¼ ì‹¤í–‰ì‹œì¼œ S3ì— ì €ì¥ëœ íŒŒì¼ë“¤ì„ ê°€ì ¸ì˜¤ë„ë¡ í•˜ê³ , Docker hub ì— ì˜¬ë¼ê°„ ì´ë¯¸ì§€ë¥¼ ë‚´ë ¤ë°›ì•„ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì´ëŸ¬í•œ íŒŒì´í”„ë¼ì¸ì— ì‚¬ìš©ë˜ëŠ” CodeBuild, CodeDeploy, CodePipeline ì„ ì§ì ‘ ì„¤ì •í•˜ëŠ” ê³¼ì •ì— ëŒ€í•´ì„œ ì •ë¦¬í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

## Prerequisite

ë¨¼ì € Docker Hub, Github ê³„ì •ê³¼ Docker Hub ì— ë°°í¬í•  ì´ë¯¸ì§€ ë ˆí¬ì§€í† ë¦¬ì™€ Github ë ˆí¬ì§€í† ë¦¬ê°€ ìƒì„±ë˜ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ ë°°í¬í•  EC2 ê°€ ì´ë¯¸ ë§Œë“¤ì–´ì ¸ ìˆìœ¼ë©° Docker ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

**Note**: CodeDeploy Agent ë„ EC2 ì— ì„¤ì¹˜ë˜ì–´ì•¼ í•˜ëŠ”ë°, ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” CodeDeploy Agent ì„¤ì¹˜ì— í•„ìš”í•œ SSM Agent ê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆëŠ” Ubuntu 18.04 ë¥¼ EC2 OSë¡œ ì‚¬ìš©í•˜ì—¬ ì„¤ì¹˜ ì‘ì—…ì„ ë„˜ì–´ê°€ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

## 1. Project Setting

CodeBuild ê°€ ìˆ˜í–‰í•  ì‘ì—…ì„ ëª…ì‹œí•˜ëŠ” buildspec íŒŒì¼ê³¼ CodeDeploy ê°€ ìˆ˜í–‰í•  ì‘ì—…ì„ ëª…ì‹œí•˜ëŠ” appspec íŒŒì¼ ë° í•„ìš”í•œ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì•„ë˜ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.

`gist:eunsukimme/6d603d80465566e89b519c42e23cf08a#appspec.yml`

`appspec.yml` ì€ CodeDeploy Agent ê°€ ìˆ˜í–‰í•  ì‘ì—…ê³¼ í™˜ê²½ì„ ì„¤ì •í•˜ëŠ” íŒŒì¼ì…ë‹ˆë‹¤. `files` ì—ì„œ `source` ëŠ” CodeBuild ë¡œ ë¶€í„° ì „ë‹¬ë°›ì€ `artifacts` ì˜ íŒŒì¼ ì‹œìŠ¤í…œ ì¤‘ ê°€ì ¸ì˜¤ê³ ì í•˜ëŠ” íŒŒì¼ë“¤ì´ê³ , `destination` ì€ ë°°í¬í•˜ê³ ì í•˜ëŠ” í˜¸ìŠ¤íŠ¸(EC2) ì˜ íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ `source` ë¡œë¶€í„° ê°€ì ¸ì˜¨ `artifacts` ê°€ ìœ„ì¹˜í•  ë””ë ‰í„°ë¦¬ë¥¼ ë§í•©ë‹ˆë‹¤.

`appspec.yml` ì—ì„œ `hooks` ëŠ” CodeBuild ì˜ `phases` ì™€ ìœ ì‚¬í•œë°, CodeDeploy ì—ì„œì˜ ì‘ì—… ë‹¨ê³„ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ê° ì‘ì—… ë‹¨ê³„ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì€ [ê³µì‹ document](https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/reference-appspec-file-structure-hooks.html) ë¥¼ ì°¸ê³ í•˜ì„¸ìš”. ì—¬ê¸°ì„œëŠ” `AfterInstall`, `ApplicationStart`, `ApplicationStop` ì„¸ ë‹¨ê³„ë¥¼ ì •ì˜í•˜ì˜€ìŠµë‹ˆë‹¤.

`gist:eunsukimme/6d603d80465566e89b519c42e23cf08a#buildspec.dev.yml`

`buildspec.dev.yml` ì€ CodeBuild ê°€ ì†ŒìŠ¤ì½”ë“œë¥¼ ë¹Œë“œí•  ë•Œ ìˆ˜í–‰í•  ì‘ì—…ê³¼ í™˜ê²½ì„ ì„¤ì •í•˜ëŠ” íŒŒì¼ì…ë‹ˆë‹¤. `phases` ëŠ” CodeBuild ì—ì„œ ì‘ì—… ë‹¨ê³„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” íŠ¹ìˆ˜í•œ ë‹¨ê³„ë“¤ë¡œ, ì—¬ê¸°ì„œëŠ” `pre_build`, `build`, `post_build` ì„¸ ë‹¨ê³„ë¥¼ ì •ì˜í•˜ì˜€ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  `artifacts` ëŠ” CodeBuild ê°€ ì‘ì—…ì„ ë§ˆì¹œ ë’¤ CodeDeploy ì—ê²Œ ì „ë‹¬í•  íŒŒì¼ë“¤ì„ ëª…ì‹œí•˜ëŠ” ë¶€ë¶„ìœ¼ë¡œ, ì—¬ê¸°ì„œëŠ” `appspec.yml` ê³¼ docker ì»¤ë§¨ë“œê°€ í¬í•¨ëœ `scripts/*` , ê·¸ë¦¬ê³  `docker-compose.dev.yml` íŒŒì¼ì„ ì „ë‹¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.

`gist:eunsukimme/6d603d80465566e89b519c42e23cf08a#Dockerfile.dev`

`Dockerfile.dev` ëŠ” ì „í˜•ì ì¸ Node.js(Typescript) ì•±ì˜ Dockerfile ì…ë‹ˆë‹¤. ë„ì»¤íŒŒì¼ì„ ë³´ë©´ ë‘ ë‹¨ê³„ë¡œ ë‚˜ëˆ ì„œ ë¹Œë“œë¥¼ ì§„í–‰í•˜ëŠ”ë°, ì²« ë‹¨ê³„(`builder`)ì—” ì†ŒìŠ¤ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ ë¹Œë“œë¥¼ ì§„í–‰í•˜ê³ , ë‘ ë²ˆì§¸ ë‹¨ê³„(`runtime`)ì—ì„  ë¹Œë“œëœ íŒŒì¼ê³¼ ë…¸ë“œ ëª¨ë“ˆë§Œì„ ê°€ì ¸ì˜¨ ë’¤ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.

`gist:eunsukimme/6d603d80465566e89b519c42e23cf08a#docker-compose.dev.yml`

`docker-compose.dev.yml` ë„ ì—­ì‹œ í‰ë²”í•œ ë„ì»¤ ì»´í¬ì¦ˆ íŒŒì¼ì…ë‹ˆë‹¤. `app` ì´ë€ ì„œë¹„ìŠ¤ ì´ë¦„ìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•  ê²ƒì„ ëª…ì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤.

`gist:eunsukimme/6d603d80465566e89b519c42e23cf08a#pullDocker.sh`

`pullDocker.sh` ëŠ” CodeDeploy ê°€ EC2 ìƒì—ì„œ ì‹¤í–‰í•  ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ì…ë‹ˆë‹¤. Docker Hub ì— ë¡œê·¸ì¸ì„ í•˜ê³  í•„ìš”í•œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. ì—¬ê¸°ì„œ `DEPLOYMENT_GROUP_NAME` ëŠ” CodeDeploy ë§Œì˜ í™˜ê²½ë³€ìˆ˜ë¡œ, deploy group ì„ ì§€ì¹­í•©ë‹ˆë‹¤. deploy group ì— ëŒ€í•´ì„  ì¡°ê¸ˆ ë’¤ì— CodeDeploy ë¥¼ ì„¤ì •í•  ë•Œ ë‹¤ì‹œ ì–˜ê¸°í•˜ê² ìŠµë‹ˆë‹¤.

`gist:eunsukimme/6d603d80465566e89b519c42e23cf08a#runDocker.sh`

`runDocker.sh` ëŠ” CodeDeploy ê°€ EC2 ìƒì—ì„œ ê°€ì ¸ì˜¨ ì´ë¯¸ì§€ë¥¼ ì»¨í…Œì´ë„ˆë¡œ ë„ìš°ëŠ” ì‰˜ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.

`gist:eunsukimme/6d603d80465566e89b519c42e23cf08a#stopDocker.sh`

ë§ˆì§€ë§‰ìœ¼ë¡œ `stopDocker.sh` ëŠ” ëª¨ë“  ì»¨í…Œì´ë„ˆë¥¼ stop ì‹œí‚¤ëŠ” ëª…ë ¹ìœ¼ë¡œ, CodeDeploy ê°€ ë°°í¬í•  ë•Œ ì œì¼ ì²˜ìŒ ì‹¤í–‰í•˜ëŠ” ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ì…ë‹ˆë‹¤.

---

## 2. Create IAM Roles

CodeBuild, CodeDeploy ë¥¼ ì„¤ì •í•˜ê¸° ì „ ë¨¼ì € í•´ë‹¹ ì„œë¹„ìŠ¤ì— í•„ìš”í•œ Role ì„ ë§Œë“¤ì–´ ì£¼ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. IAM ì„œë¹„ìŠ¤ í™”ë©´ì—ì„œ `Create Role` ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.01.43_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.01.43_PM.png)

### Role for CodeBuild

ì œì¼ ë¨¼ì € CodeBuild ì— í•„ìš”í•œ Role ì„ ìƒì„±í•´ì¤ì‹œë‹¤. ì„œë¹„ìŠ¤ ëª©ë¡ ì¤‘ `CodeBuild` ë¥¼ ì„ íƒí•˜ê³  `Next` ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.02.56_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.02.56_PM.png)

CodeBuild ëŠ” ë¹Œë“œê°€ ì™„ë£Œëœ ë’¤ ë§Œë“¤ì–´ì§„ artifacts ë¥¼ S3 ì— ì˜¬ë¦¬ê¸° ë•Œë¬¸ì— S3 ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” `AmazonS3FullAccess` ë¥¼ ì£¼ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.03.29_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.03.29_PM.png)

ë§ˆì§€ë§‰ìœ¼ë¡œ Role ì´ë¦„ì„ ì„¤ì •í•œ ë’¤ `Create Role` ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ìƒì„±í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.04.31_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.04.31_PM.png)

### Role for CodeDeploy

ë‹¤ìŒìœ¼ë¡œ CodeDeploy ì— í•„ìš”í•œ Role ì„ ìƒì„±í•´ì¤ì‹œë‹¤. ì´ ë•Œ ì„œë¹„ìŠ¤ë¡œ `CodeDeploy` ë¥¼ ì„ íƒí•œ ë’¤ ìœ ìŠ¤ì¼€ì´ìŠ¤ë¡œ `CodeDeploy` ë¥¼ ì„ íƒí•´ì£¼ë©´ ë©ë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.15.54_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.15.54_PM.png)

CodeDeploy ì˜ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ `AWSCodeDeployRole` ì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ë‹¤ë¥¸ ì„¤ì •ì€ ëª¨ë‘ ê±´ë„ˆ ë›°ê³  Role ì´ë¦„ì„ ì„¤ì •í•œ ë’¤ `Create Role` ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ìƒì„±ì„ ì™„ë£Œí•´ì¤ì‹œë‹¤.(ì•„ë˜ ì‚¬ì§„ì—ì„œ Permission boundary ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ë°, ì˜ëª» ì„¤ì •í•œ ê²ƒì´ë‹ˆ ë¬´ì‹œí•˜ì‹œë©´ ë©ë‹ˆë‹¤.)

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.20.22_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.20.22_PM.png)

CodeDeploy ì˜ ê²½ìš° CodeBuild ì—ì„œ ìƒì„±ëœ artifacts ë¥¼ ê°€ì ¸ì™€ì•¼ í•˜ê¸° ë•Œë¬¸ì— S3ì— ì ‘ê·¼í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ë§ˆì°¬ê°€ì§€ë¡œ permission policy ë¡œ `AamazonS3FullAccess` ë¥¼ ë¶€ì—¬í•´ì¤ì‹œë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.26.04_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.26.04_PM.png)

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.34.42_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.34.42_PM.png)

---

## 3. Create CodeBuild Project

ì, ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ CodeBuild í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.

### Project Configuration

CodeBuild ì„œë¹„ìŠ¤ í™”ë©´ì—ì„œ `Create build project` ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_6.56.38_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_6.56.38_PM.png)

ì œì¼ ë¨¼ì € ë¹Œë“œ í”„ë¡œì íŠ¸ì˜ ì´ë¦„ì„ ì„¤ì •í•´ì¤ì‹œë‹¤. ì—¬ê¸°ì„œëŠ” `codepipeline-test` ë¼ê³  ì£¼ì—ˆìŠµë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_6.57.45_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_6.57.45_PM.png)

### Source

ë‹¤ìŒìœ¼ë¡œ ì–´ë””ì„œ ì½”ë“œë¥¼ ê°€ì ¸ì˜¬ ê²ƒì¸ì§€ë¥¼ ëª…ì‹œí•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. `Source provider` ë¥¼ `Github` ìœ¼ë¡œ ì„¤ì •í•˜ê³ , ê°œì¸ ê³„ì •ì—ì„œ í•´ë‹¹ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•´ì¤ì‹œë‹¤. `Source version` ì—ì„œ ë¸Œëœì¹˜ ì´ë¦„ì„ ì£¼ë©´ í•´ë‹¹ ë¸Œëœì¹˜ì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Note**: ì´ë•Œ ì£¼ì˜í•´ì•¼ í•  ê²ƒì€ `Primary soource webhook events` ì›¹í›… ì²´í¬ë°•ìŠ¤ëŠ” í•´ì œí•´ì•¼ í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ë‚˜ì¤‘ì— CodePipeline ì„ ì„¤ì •í•´ì¤„ ë•Œ ì›¹í›…ì„ ì ìš©í•˜ê¸° ë•Œë¬¸ì— ì—¬ê¸°ì„œ ì ìš©í•˜ë©´ í‘¸ì‹œí•  ë•Œ ë¹Œë“œê°€ ë‘ ë²ˆ ëŒì•„ê°€ê²Œ ë©ë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_6.58.27_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_6.58.27_PM.png)

### Environment

ë‹¤ìŒìœ¼ë¡œ í”„ë¡œë¹„ì €ë‹í•  ë•Œ ì‚¬ìš©ë˜ëŠ” í™˜ê²½ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ OS ëŠ” `Amazon Linux 2` ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ê·¸ ì•„ë˜ ëŸ°íƒ€ì„ê³¼ ì´ë¯¸ì§€ ë“±ì€ ì‚¬ì§„ì— ë‚˜ì™€ìˆëŠ” ê²ƒê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

ì´ë•Œ ë§¨ ì•„ë˜ì— `Privileged` ì„¹ì…˜ì—ì„œ ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ Docker ë¥¼ ì‚¬ìš©í•´ì„œ ë¹Œë“œë¥¼ í•˜ê³ , ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ Docker hub ì— ì˜¬ë ¤ì•¼ í•˜ê¸° ë•Œë¬¸ì— Docker ê°€ ì„¤ì¹˜ëœ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.05.09_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.05.09_PM.png)

ê·¸ëŸ° ë‹¤ìŒ `Service role` ë¡œ ì¡°ê¸ˆ ì „ì— ë§Œë“¤ì–´ì¤€ CodeBuild role ì„ ì œê³µí•˜ë©´ ë©ë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.07.47_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.07.47_PM.png)

### Buildspec

ë§ˆì§€ë§‰ìœ¼ë¡œ CodeBuild ê°€ ì°¸ì¡°í•  íŒŒì¼ì¸ buildspec ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” `buildspec.dev.yml` ì´ë€ ì´ë¦„ì˜ íŒŒì¼ì„ ì°¸ì¡°í•˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.08.30_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.08.30_PM.png)

ë§¨ ì•„ë˜ ì™„ë£Œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ë©´ ì´ë¡œì¨ CodeBuild ì„¤ì •ì€ ëë‚¬ìŠµë‹ˆë‹¤.

---

## 4. Create CodeDeploy Project

ì, ì´ì œ CodeBuild ë‹¤ìŒ ë‹¨ê³„ì¸ CodeDeploy ë¥¼ ì„¤ì •í•´ì£¼ë„ë¡ í•©ì‹œë‹¤.

### Application Configuration

CodeBuild ì—ì„œëŠ” projectë¼ëŠ” ìš©ì–´ë¡œ ë¹Œë“œ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í–ˆëŠ”ë°, CodeDeploy ì—ì„œëŠ” ë¹„ìŠ·í•œ ê°œë…ìœ¼ë¡œ application ì´ë€ ìš©ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. CodeDeploy ì„œë¹„ìŠ¤ í™”ë©´ì—ì„œ `Create application` ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ìƒˆë¡œìš´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ìƒì„±í•´ ì¤ì‹œë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.09.00_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.09.00_PM.png)

ì œì¼ ë¨¼ì € ì–´í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„ì„ ì„¤ì •í•˜ê³ , `Compute platform` ë¥¼ `EC2/On-premises` ë¡œ ì„¤ì •í•´ ì¤ì‹œë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.09.25_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.09.25_PM.png)

ì´ë ‡ê²Œ í•˜ë©´ í•˜ë‚˜ì˜ CodeDeploy application ì´ ìƒì„±ë©ë‹ˆë‹¤. ë” ìì„¸í•œ ì„¤ì •ì€ ì•„ë˜ Deployment Group ì—ì„œ í•˜ê²Œ ë©ë‹ˆë‹¤.

### Deployment Group

Application ì„ ìƒì„±í•œ ë’¤ í•˜ìœ„ ê°œë…ì¸ deployment group ì„ ìƒˆë¡œ ë§Œë“¤ì–´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ application ì•ˆì— deployment group ì´ ì¡´ì¬í•˜ëŠ” ì´ìœ ëŠ” í™˜ê²½ ë³„ë¡œ ë‹¤ë¥¸ ë°°í¬ ì •ì±…ì„ ì ìš©í•˜ê¸° ìœ„í•¨ ì…ë‹ˆë‹¤.

ì¼ë‹¨ `Create deployment group` ì„ ëˆŒëŸ¬ì„œ ìƒˆë¡œìš´ ê·¸ë£¹ì„ ìƒì„±í•´ ì¤ì‹œë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.09.58_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.09.58_PM.png)

ì œì¼ ë¨¼ì € ê·¸ë£¹ ì´ë¦„ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„  `dev` ë€ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ role ì„ ì„¤ì •í•´ì•¼ í•˜ëŠ”ë°, ì—­ì‹œ ë§¨ ì²˜ìŒ ìƒì„±í–ˆë˜ CodeDeploy role ì„ ì œê³µí•˜ë©´ ë©ë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.21.11_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.21.11_PM.png)

### Environment

CodeBuild ì—ì„œëŠ” Environment ê°€ ë¹Œë“œí•˜ê¸° ìœ„í•´ í”„ë¡œë¹„ì €ë‹ í•  í™˜ê²½ì„ ì„¤ì •í•˜ëŠ” ê²ƒì´ì—ˆë‹¤ë©´, CodeDeploy ì—ì„œ Environment ëŠ” ì‹¤ì œë¡œ ë°°í¬í•  í™˜ê²½, ì¦‰ ìš°ë¦¬ì˜ EC2 ë¥¼ ê°€ë¦¬ì¼œì•¼ í•©ë‹ˆë‹¤.

`Amazon EC2 instances` ë¥¼ ì„ íƒí•œ ë’¤ `Key` ëŠ” `Name` ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ EC2 ì˜ ì´ë¦„ìœ¼ë¡œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ í•˜ê³ , `Value` ë¡œ ë°°í¬í•˜ê³ ì í•˜ëŠ” EC2 ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì¤ì‹œë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.21.54_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.21.54_PM.png)

### Agent Configuration

ë‹¤ìŒìœ¼ë¡œ CodeDeploy Agent ë¥¼ ì„¤ì¹˜í•˜ëŠ” ì •ì±…ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ë§¨ ì²˜ìŒ ë‹¨ í•œë²ˆ ì„¤ì¹˜í•˜ë„ë¡ `Only once` ë¥¼ ì„ íƒí•´ì¤ì‹œë‹¤.

### Deployment Settings

`Deployment settings` ëŠ” ë°°í¬ ì „ëµì„ ë§í•˜ëŠ”ë°, í•œë²ˆì— ëª¨ë“  EC2 ë¥¼ ë°°í¬í•  ê²ƒì¸ì§€ ë˜ëŠ” í•˜ë‚˜ì”© ë°°í¬í•  ê²ƒì¸ì§€ ë“±ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” `CodeDeployDefault.AllAtOnce` ë¡œ ì„¤ì •í•´ì„œ ëª¨ë“  EC2 ë¥¼ ë™ì‹œì— ë°°í¬í•˜ë„ë¡ ì„¤ì •í•˜ê² ìŠµë‹ˆë‹¤.

### Load Balancer

ë§ˆì§€ë§‰ìœ¼ë¡œ `Load balancer` ë¥¼ ì„¤ì •í•´ì„œ ë°°í¬ ì¤‘ íŠ¸ë˜í”½ì„ ì¡°ì ˆí•  ìˆ˜ ìˆëŠ”ë°, ì—¬ê¸°ì„œëŠ” ë‹¤ë£¨ì§€ ì•Šê² ìŠµë‹ˆë‹¤. ì²´í¬ë°•ìŠ¤ë¥¼ í•´ì œí•œ ë’¤ `Create deployment group` ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ìƒì„±ì„ ì™„ë£Œí•´ì¤ì‹œë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.22.37_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.22.37_PM.png)

---

## 5. Create CodePipeline

ì, ì´ì œ CodePipeline ì„ ìƒì„±í•´ì„œ ì´ì „ì— ë§Œë“  CodeBuild ì™€ CodeDeploy ë¥¼ ì´ì–´ì£¼ë„ë¡ í•©ì‹œë‹¤. CodePipeline ì„œë¹„ìŠ¤ í™”ë©´ì—ì„œ `Create pipeline` ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.23.36_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.23.36_PM.png)

### Pipeline settings

ì œì¼ ë¨¼ì € íŒŒì´í”„ë¼ì¸ì˜ ì´ë¦„ì„ ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  role ì„ ì„¤ì •í•  ìˆ˜ ìˆëŠ”ë° ì—¬ê¸°ì„œëŠ” ìƒˆë¡œìš´ role ì„ ë§Œë“¤ì–´ ì£¼ëŠ” ê±¸ ì„ íƒí•´ ì¤ì‹œë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_8.35.35_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_8.35.35_PM.png)

### Add Source Stage

ë‹¤ìŒìœ¼ë¡œ ì½”ë“œë¥¼ ì–´ë””ì„œ ê°€ì ¸ì˜¬ ê²ƒì¸ì§€ë¥¼ ì„ íƒí•´ì¤ì‹œë‹¤. CodeBuild ì—ì„œì™€ ë™ì¼í•˜ê²Œ ì„¤ì •í•´ì£¼ë©´ ë©ë‹ˆë‹¤. `Source provider` ë¥¼ `Github` ìœ¼ë¡œ ì„¤ì •í•œ ë’¤ ë ˆí¬ì§€í† ë¦¬ì™€ ë¸Œëœì¹˜ë¥¼ ì§€ì •í•´ì¤ì‹œë‹¤.

ê·¸ë¦¬ê³  `Change detection options` ë¥¼ `Github webhooks` ë¡œ ì„¤ì •í•´ì¤˜ì„œ remote ìƒì—ì„œ íŒŒì¼ì˜ ë³€í™”ê°€ ìƒê²¼ì„ ë•Œ í•´ë‹¹ íŒŒì´í”„ë¼ì¸ì´ ì‹¤í–‰ë˜ë„ë¡ í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.44.34_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.44.34_PM.png)

### Add Build Stage

ë‹¤ìŒìœ¼ë¡œ ë¹Œë“œ ë‹¨ê³„ì—ì„œ ì‹¤í–‰í•  ì‘ì—…ì„ ì •ì˜í•´ì¤ì‹œë‹¤. `Build provider` ëŠ” `AWS CodeBuild` ë¡œ ì„¤ì •í•˜ê³ , ì´ì „ì— ë§Œë“  CodeBuild í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ë©´ ë©ë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.45.28_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.45.28_PM.png)

### Add Deploy Stage

ë§ˆì§€ë§‰ìœ¼ë¡œ ë°°í¬ ë‹¨ê³„ì—ì„œ ì‹¤í–‰í•  ì‘ì—…ì„ ì •ì˜í•´ì¤ì‹œë‹¤. `Deploy provider` ëŠ” `AWS CodeDeploy` ë¡œ ì„¤ì •í•œ ë’¤ ì¡°ê¸ˆ ì „ì— ë§Œë“¤ì—ˆë˜ CodeDeploy ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì„ íƒí•˜ê³ , ë°°í¬í•  ê·¸ë£¹ì„ ì„¤ì •í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.46.02_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.46.02_PM.png)

ì, ì´ë¡œì¨ CodeBuild, CodeDeploy, CodePipeline ê¹Œì§€ ëª¨ë“  ì„¤ì •ì´ ëë‚¬ìŠµë‹ˆë‹¤. `Next` ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜„ì¬ê¹Œì§€ ì„¤ì •í•œ ê²ƒë“¤ì„ review í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë§ˆì € ì™„ë£Œí•˜ë©´ í•´ë‹¹ íŒŒì´í”„ë¼ì¸ì´ ìƒì„±ë˜ê³ , ë‹¤ìŒê³¼ ê°™ì´ ì•Œì•„ì„œ íŒŒì´í”„ë¼ì¸ì´ ëŒì•„ê°€ê³  ìˆëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.56.15_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_7.56.15_PM.png)

---

## 6. Test Your Pipeline

ì‹¤ì œë¡œ ë°°í¬ê°€ ì˜ ì´ë¤„ì¡ŒëŠ”ì§€ í™•ì¸í•´ë³¼ê¹Œìš”? ssh ë¡œ EC2 ì— ì ‘ì†í•´ì„œ `appspec.yml` ì— ì •ì˜í–ˆë˜ `destination` í´ë”(`/deploy`)ë¥¼ í™•ì¸í•´ë´…ì‹œë‹¤. ì•„ë˜ ì‚¬ì§„ì—ì„œ ì•Œ ìˆ˜ ìˆë“¯ì´ `buildspec.dev.yml` ì•ˆì˜ `artifacts` ì—ì„œ ì •ì˜í–ˆë˜ íŒŒì¼ë“¤ì´ `/deploy` í´ë”ì— ì¡´ì¬í•˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`docker ps` ëª…ë ¹ìœ¼ë¡œ docker í”„ë¡œì„¸ìŠ¤ê°€ ì˜ ì‹¤í–‰ë˜ê³  ìˆëŠ” ê²ƒ ë˜í•œ í™•ì¸í•  ìˆ˜ ìˆë„¤ìš”.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_8.06.22_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_8.06.22_PM.png)

EC2 ì˜ ip ì£¼ì†Œì™€ ì„œë²„ì— í• ë‹¹ëœ í¬íŠ¸ë²ˆí˜¸ë¥¼ ë¸Œë¼ìš°ì €ì— ì…ë ¥í•´ì„œ ì ‘ì†ì„ ì‹œë„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì˜ ì—°ê²°ë˜ëŠ” ê²ƒ ë˜í•œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_8.06.55_PM.png](/media/node_codebuild_codedeploy_codepipeline/Screen_Shot_2020-08-24_at_8.06.55_PM.png)

---

## Recap

ì§€ê¸ˆê¹Œì§€ AWS IAM, CodeBuild, CodeDeploy, CodePipeline ê³¼ Docker ë¥¼ í™œìš©í•˜ì—¬ Node.js í”„ë¡œì íŠ¸ì˜ CI/CD ë¥¼ êµ¬ì¶•í•˜ëŠ” ê³¼ì •ì— ëŒ€í•´ì„œ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” í•˜ë‚˜ì˜ EC2 ë¡œë§Œ ë°°í¬í•˜ê³  ìˆëŠ”ë°, ì‹¤ì œë¡œëŠ” ì—¬ëŸ¬ EC2 ë¡œ ë°°í¬í•  ìˆ˜ ìˆìœ¼ë©° ì´ ë•Œ ë¡œë“œë°¸ëŸ°ì‹±ì„ ì ìš©í•˜ì—¬ ë°°í¬ ì‹œ ë°œìƒí•˜ëŠ” ë‹¤ìš´íƒ€ì„ì„ ìµœì†Œí™” ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ ì—¬ê¸°ì„œëŠ” Docker Hub ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ í•˜ê³  ìˆëŠ”ë°, AWS ECR ì— ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ê³  ë˜ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°œë°œìê°€ ì›í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ë°°í¬ í™˜ê²½ì„ ì„¤ì •í•  ìˆ˜ ìˆëŠ” AWS CodePipeline! ì •ë§ì´ì§€ ì•ˆ ì“°ê³ ëŠ” ëª» ë°°ê¸°ê² ìŠµë‹ˆë‹¤ğŸ˜€.

## References

- [Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/)

- [AWS ì‹œìŠ¤í…œ ê´€ë¦¬ìë¥¼ ì‚¬ìš©í•˜ì—¬ CodeDeploy ì—ì´ì „íŠ¸ ì„¤ì¹˜](https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/codedeploy-agent-operations-install-ssm.html)

- [AppSpec 'hooks' ì„¹ì…˜](https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/reference-appspec-file-structure-hooks.html)

- [Cloud Journey IO](https://www.cloudjourney.io/articles/devops/aws-codepipeline-td/)
